<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>@oAdam TERMINAL V23</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        @font-face { font-family: 'TechMono'; src: local('Courier New'), monospace; }

        /* --- 1. ÈªòËÆ§ÊöóÈªë‰∏ªÈ¢ò (Dark Mode) --- */
        :root {
            --bg: #050505;
            --text-main: #ccc;
            --text-head: #888;
            --panel: rgba(18, 18, 22, 0.95);
            --pri: #00f3ff;
            --dan: #ff003c;
            --safe: #00ff9f;
            --warn: #ffcc00;
            --dim: #666;
            --border: 1px solid rgba(255,255,255,0.12);
            --input-border: #333;
            --dock-bg: rgba(8, 8, 8, 0.98);
            --ai-bg: rgba(0,0,0,0.95);
            --hero-bg: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiMzMzMiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMCAwaDQwdjQwSDBWMHptMjAgMjBoMjB2MjBIMjAyMHoiLz48L2c+PC9nPjwvc3ZnPg==');
            --btn-radius: 6px;
            --panel-radius: 6px;
            --shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        /* --- 2. Êòé‰∫Æ‰∏ªÈ¢ò (Light Mode) --- */
        body.light-mode {
            --bg: #f0f2f5;
            --text-main: #333;
            --text-head: #555;
            --panel: #ffffff;
            --pri: #007acc;
            --dan: #d32f2f;
            --safe: #00994d;
            --warn: #f57c00;
            --dim: #888;
            --border: 1px solid #e0e0e0;
            --input-border: #ddd;
            --dock-bg: rgba(255,255,255,0.98);
            --ai-bg: #f5f5f5;
            --hero-bg: none;
            --shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* --- 3. ÈªëÁôΩÂÉèÁ¥†‰∏ªÈ¢ò (Pixel Mode) --- */
        body.pixel-mode {
            --bg: #e0e0e0;
            --text-main: #000;
            --text-head: #000;
            --panel: #ffffff;
            --pri: #000;
            --dan: #000;
            --safe: #000;
            --warn: #000;
            --dim: #555;
            --border: 2px solid #000;
            --input-border: #000;
            --dock-bg: #fff;
            --ai-bg: #fff;
            --hero-bg: radial-gradient(#000 15%, transparent 16%) 0 0, radial-gradient(#000 15%, transparent 16%) 4px 4px;
            background-size: 8px 8px;
            --btn-radius: 0px;
            --panel-radius: 0px;
            --shadow: 4px 4px 0px #000;
        }
        body.pixel-mode .c-pri, body.pixel-mode .c-dan { text-shadow: none; font-weight: 900; }
        body.pixel-mode .btn { border: 2px solid #000; box-shadow: 2px 2px 0 #000; }
        body.pixel-mode .btn:active { transform: translate(2px, 2px); box-shadow: none; }
        body.pixel-mode .source-tag { background: #fff; color: #000; border: 2px solid #000; }
        body.pixel-mode .source-tag.active { background: #000; color: #fff; border: 2px solid #000; }
        body.pixel-mode .bar-fill { background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg); color: var(--text-main);
            font-family: 'TechMono', monospace;
            margin: 0; padding: 8px; 
            font-size: 13px;
            padding-bottom: 60px;
            background-image: var(--hero-bg);
            transition: background 0.3s, color 0.3s;
        }

        /* --- Â∏ÉÂ±ÄÈÄöÁî® --- */
        .flex { display: flex; }
        .j-between { justify-content: space-between; }
        .a-center { align-items: center; }
        .gap-1 { gap: 5px; }
        .gap-2 { gap: 8px; }
        .col { flex-direction: column; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mt-1 { margin-top: 4px; }
        .bold { font-weight: 800; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .full-w { width: 100%; }
        .pointer { cursor: pointer; }
        .h-full { height: 100%; }

        /* --- È¢úËâ≤ --- */
        .c-pri { color: var(--pri); transition: color 0.3s; }
        .c-dan { color: var(--dan); transition: color 0.3s; }
        .c-safe { color: var(--safe); transition: color 0.3s; }
        .c-warn { color: var(--warn); transition: color 0.3s; }
        .c-dim { color: var(--dim); transition: color 0.3s; }
        body:not(.light-mode):not(.pixel-mode) .c-pri { text-shadow: 0 0 8px rgba(0,243,255,0.3); }
        body:not(.light-mode):not(.pixel-mode) .c-dan { text-shadow: 0 0 8px rgba(255,0,60,0.3); }

        /* --- Èù¢Êùø --- */
        .panel {
            background: var(--panel);
            border: var(--border); padding: 8px 10px; margin-bottom: 8px;
            box-shadow: var(--shadow); border-radius: var(--panel-radius);
            transition: background 0.3s, border 0.3s;
            display: flex; flex-direction: column; justify-content: center;
        }
        .panel-head {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--input-border); padding-bottom: 4px; margin-bottom: 6px;
            font-size: 10px; color: var(--text-head); letter-spacing: 0.5px;
        }

        /* --- Â§¥ÈÉ® (ÂÆΩÊïûÁâà) --- */
        .header-area { margin-bottom: 6px; padding: 0 2px; height: 32px; }
        
        .brand-logo { font-size: 16px; letter-spacing: 0px; font-weight: 900; margin-right: 8px; }
        .brand-logo a { color: inherit; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
        .brand-logo a:hover { border-bottom-color: var(--pri); }
        
        .source-tag { 
            font-size: 9px; padding: 2px 6px; height: 18px; line-height: 12px;
            background: var(--input-border); border-radius: 3px; cursor: pointer; border: 1px solid transparent; color: var(--text-head); 
            display: inline-flex; align-items: center; justify-content: center;
        }
        .source-tag.active { border-color: var(--safe); color: var(--safe); background: rgba(0,255,159,0.1); }
        
        .theme-btn { width: 20px; height: 20px; border-radius: 50%; border: 1px solid var(--dim); display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; background: var(--input-border); color: var(--text-main); }

        .header-right {
            display: flex; align-items: center; gap: 8px; height: 100%;
            padding-right: 12px; 
        }
        .price-hero { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; transition: color 0.2s; line-height: 1; }
        
        select#tokenSelect {
            -webkit-appearance: none; 
            background: transparent; border: none; 
            color: var(--pri); font-weight: 900; 
            font-size: 20px; 
            text-align: right; cursor: pointer;
            padding: 0; margin: 0; width: auto;
            font-family: inherit;
        }

        /* --- ËæìÂÖ•Ê°Ü --- */
        .input-group { position: relative; width: 100%; }
        .input-label { font-size: 9px; color: var(--dim); position: absolute; top: 0px; left: 0; pointer-events: none; }
        input {
            background: transparent; border: none; border-bottom: 1px solid var(--input-border);
            color: var(--text-main); width: 100%; text-align: right; font-family: inherit;
            font-size: 15px; outline: none; padding-top: 12px; font-weight: bold;
            transition: border 0.3s;
        }
        input:focus { border-color: var(--pri); }
        .short input:focus { border-color: var(--dan); }
        
        .input-center input { text-align: center; font-size: 16px; }
        .input-center .input-label { width: 100%; text-align: center; left: 0; }

        /* --- Ê®°ÊãüÊ≤ôÁõò --- */
        .sim-box {
            background: rgba(128,128,128,0.05); border: 1px dashed var(--dim); padding: 6px; border-radius: var(--panel-radius);
        }
        .sim-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px; }
        .sim-val { font-weight: bold; }
        .unit-tag { position: absolute; right: 0; top: 14px; font-size: 9px; color: var(--dim); }

        /* --- Á≠ñÁï•Ë°® --- */
        .strat-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .strat-table td { padding: 5px 2px; border-bottom: 1px dashed var(--input-border); cursor: pointer; }
        .strat-table tr:hover { background: rgba(128,128,128,0.1); }
        .strat-btn { font-size: 9px; padding: 1px 5px; border: 1px solid var(--dim); border-radius: 3px; color: var(--dim); }

        /* --- Â∫ïÈÉ®Âå∫Âüü --- */
        .bottom-area {
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
        }

        /* AI ÁªàÁ´Ø */
        .ai-terminal {
            height: 36px; overflow: hidden; 
            padding: 2px 10px; font-size: 9px; color: var(--dim); font-family: monospace;
            border-top: 1px solid var(--input-border); 
            background: var(--ai-bg); 
            backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: flex-end;
            line-height: 11px;
        }
        .ai-log-item { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 2px solid transparent; padding-left: 6px; 
        }
        .ai-log-item.new { border-left-color: var(--pri); color: var(--text-main); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: 0; } }

        /* Dock */
        .dock {
            display: flex; gap: 6px; padding: 6px 10px 8px 10px;
            background: var(--dock-bg); border-top: 1px solid var(--input-border);
        }
        .btn {
            flex: 1; padding: 6px 0;
            background: var(--panel); border: 1px solid var(--input-border);
            color: var(--dim); cursor: pointer; border-radius: var(--btn-radius); font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1px;
            transition: all 0.1s;
        }
        .btn:active { background: var(--input-border); color: var(--pri); transform: scale(0.98); }
        .btn i { font-size: 14px; font-style: normal; }

        /* --- Modal (‰ºòÂåñÁâà) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 9999; 
            display: none; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px); 
        }
        
        .modal-overlay.show { display: flex !important; }

        .modal { 
            background: var(--panel); border: 1px solid var(--pri); 
            width: 85%; max-width: 320px; padding: 25px 20px; 
            border-radius: var(--panel-radius); box-shadow: 0 0 30px rgba(0,0,0,0.4); color: var(--text-main); 
        }
        
        .modal-input-col { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; margin-top: 10px; }
        .modal-input-item input { font-size: 13px; padding-top: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--dim); }
        
        .toggle-switch { display: flex; align-items: center; gap: 10px; font-size: 12px; margin-bottom: 20px; cursor: pointer; color: var(--dim); }
        .toggle-box { width: 32px; height: 16px; background: var(--input-border); border-radius: 8px; position: relative; transition: 0.3s; }
        .toggle-box.active { background: var(--pri); }
        .toggle-dot { width: 12px; height: 12px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-box.active .toggle-dot { left: 18px; }
        
        .modal-btn { 
            background: var(--pri); color: #000; border: none; padding: 10px 0; 
            font-weight: bold; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%;
        }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="flex j-between a-center header-area">
        <div class="flex a-center gap-2">
            <div class="brand-logo c-pri">
                <a href="https://x.com/0xkillcoin" target="_blank">@oAdam</a>
            </div>
            <div class="flex gap-1 a-center">
                <div class="source-tag active" id="srcBinance" onclick="setSource('binance')">BINANCE</div>
                <div class="source-tag" id="srcOkx" onclick="setSource('okx')">OKX</div>
            </div>
            <div class="theme-btn" onclick="toggleTheme()" id="themeIcon">‚òÄÔ∏è</div>
        </div>
        
        <div class="header-right">
            <select id="tokenSelect" onchange="changeToken()">
                <option value="ETH">ETH</option><option value="BTC">BTC</option><option value="SOL">SOL</option><option value="BNB">BNB</option><option value="DOGE">DOGE</option><option value="XRP">XRP</option><option value="ADA">ADA</option><option value="AVAX">AVAX</option><option value="LINK">LINK</option><option value="DOT">DOT</option>
                <option value="PEPE">PEPE</option><option value="ORDI">ORDI</option><option value="SATS">SATS</option><option value="SHIB">SHIB</option><option value="WIF">WIF</option><option value="BONK">BONK</option><option value="FLOKI">FLOKI</option><option value="BOME">BOME</option>
                <option value="ARB">ARB</option><option value="OP">OP</option><option value="MATIC">MATIC</option><option value="TIA">TIA</option><option value="SUI">SUI</option><option value="APT">APT</option><option value="NEAR">NEAR</option><option value="FIL">FIL</option><option value="ATOM">ATOM</option><option value="ICP">ICP</option><option value="LTC">LTC</option><option value="BCH">BCH</option><option value="ETC">ETC</option><option value="UNI">UNI</option><option value="AAVE">AAVE</option><option value="MKR">MKR</option><option value="SNX">SNX</option><option value="DYDX">DYDX</option><option value="CRV">CRV</option><option value="LDO">LDO</option><option value="RNDR">RNDR</option><option value="FET">FET</option><option value="AGIX">AGIX</option><option value="WLD">WLD</option><option value="PYTH">PYTH</option><option value="JUP">JUP</option><option value="JTO">JTO</option><option value="SEI">SEI</option><option value="BLUR">BLUR</option><option value="SAND">SAND</option><option value="MANA">MANA</option><option value="AXS">AXS</option>
            </select>
            <div id="priceDisplay" class="price-hero c-pri">--.--</div>
        </div>
    </div>

    <!-- 1. Core Monitor -->
    <div class="panel">
        <div class="panel-head">
            <span>CORE MONITOR</span>
            <span class="c-dim bold" id="levDisplay">50X</span>
        </div>
        <div class="flex j-between a-center mb-1">
            <span class="c-dim">Êú™ÁªìÁõà‰∫è (PNL)</span>
            <span id="netPnl" class="bold" style="font-size:18px">0.00</span>
        </div>
        <div class="flex j-between a-center" style="border-bottom:1px dashed var(--input-border); padding-bottom:6px; margin-bottom:6px;">
            <span class="c-dim">ÂÆûÊó∂ÂáÄÂÄº (EQUITY)</span>
            <span id="equity" class="bold c-safe" style="font-size:18px">0.00</span>
        </div>
        <div class="flex j-between a-center mt-1">
            <span class="c-dim">È£éÈô©ÊïûÂè£ (DELTA)</span>
            <span id="netDelta">0.000</span>
        </div>
        <div style="margin-top:8px; height:4px; background:var(--input-border); border-radius:2px; overflow:hidden;">
            <div id="riskBar" style="height:100%; width:0%; background:var(--safe); transition:0.5s;"></div>
        </div>
        <div class="flex j-between mt-1" style="font-size:9px">
            <span id="liqText">LIQ: SAFE</span>
            <span id="riskText">RISK: LOW</span>
        </div>
    </div>

    <!-- 2. Wallet & Leverage -->
    <div class="flex gap-2 mb-2">
        <div class="panel flex-1" style="margin-bottom:0; padding:6px;">
            <div class="input-group input-center">
                <span class="input-label">Èí±ÂåÖ‰ΩôÈ¢ù (U)</span>
                <input type="number" id="wallet" value="2800" oninput="calcAll()">
            </div>
        </div>
        <div class="panel flex-1" style="margin-bottom:0; padding:6px;">
            <div class="input-group input-center">
                <span class="input-label">Êù†ÊùÜÂÄçÊï∞ (X)</span>
                <input type="number" id="lev" value="52" oninput="calcAll()">
            </div>
        </div>
    </div>

    <!-- 3. Positions -->
    <div class="flex gap-2 mb-2">
        <div class="panel flex-1" style="margin-bottom:0">
            <div class="flex j-between mb-1">
                <span class="c-pri bold" style="font-size:11px">LONG (Â§ö)</span>
                <span id="lPnl" class="c-dim" style="font-size:9px">0</span>
            </div>
            <div class="col gap-1">
                <div class="input-group"><span class="input-label">Âùá‰ª∑</span><input type="number" id="lPrice" oninput="calcAll()"></div>
                <div class="input-group"><span class="input-label">Êï∞Èáè</span><input type="number" id="lSize" oninput="calcAll()"></div>
            </div>
        </div>
        <div class="panel flex-1" style="margin-bottom:0; border-color:rgba(255,0,60,0.3)">
            <div class="flex j-between mb-1">
                <span class="c-dan bold" style="font-size:11px">SHORT (Á©∫)</span>
                <span id="sPnl" class="c-dim" style="font-size:9px">0</span>
            </div>
            <div class="col gap-1 short">
                <div class="input-group"><span class="input-label">Âùá‰ª∑</span><input type="number" id="sPrice" oninput="calcAll()"></div>
                <div class="input-group"><span class="input-label">Êï∞Èáè</span><input type="number" id="sSize" oninput="calcAll()"></div>
            </div>
        </div>
    </div>

    <!-- 4. Tactical Sim -->
    <div class="panel">
        <div class="panel-head" style="border-bottom:none; margin-bottom:0">
            <span class="c-warn">TACTICAL SIM</span>
            <span class="c-dim" style="font-size:9px">PREVIEW</span>
        </div>
        <div class="sim-box">
            <div class="flex gap-2 mb-1">
                <div class="flex-1 input-group">
                    <span class="input-label">Ê®°Êãü‰ª∑Ê†º</span>
                    <input type="number" id="simPrice" placeholder="0.00" oninput="calcSim()">
                </div>
                <div class="flex-1 input-group">
                    <span class="input-label">Êï∞Èáè</span>
                    <input type="number" id="simAmt" placeholder="0.2" step="0.01" oninput="calcSim()">
                    <span class="unit-tag" id="simUnit">ETH</span>
                </div>
            </div>
            <div style="border-top:1px dashed var(--input-border); padding-top:4px;">
                <div class="sim-row">
                    <span class="c-dim">New AVG</span>
                    <span id="simNewAvg" class="sim-val">--</span>
                </div>
                <div class="sim-row">
                    <span class="c-dim">New LIQ</span>
                    <span id="simNewLiq" class="sim-val">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Strategy Matrix -->
    <div class="panel">
        <div class="panel-head">
            <span class="c-safe">STRATEGY MATRIX</span>
            <span class="c-dim" style="font-size:9px">AUTO</span>
        </div>
        <div id="stratContent">
            <div class="c-dim text-center py-2">Waiting for data...</div>
        </div>
    </div>

    <!-- Bottom Area -->
    <div class="bottom-area">
        <div id="aiLog" class="ai-terminal">
            <div class="ai-log-item">System @oAdam V23.</div>
            <div class="ai-log-item">Data Persistence Active.</div>
        </div>
        <div class="dock">
            <button class="btn" onclick="document.getElementById('ocrInput').click()"><i>üì∑</i> ËØÜÂà´</button>
            <button class="btn" onclick="openTG()"><i>‚öôÔ∏è</i> TG</button>
            <button class="btn" onclick="sendReport()"><i>üì°</i> ÁÆÄÊä•</button>
            <button class="btn" onclick="switchSource()"><i>üîÑ</i> Êç¢Ê∫ê</button>
        </div>
    </div>

    <input type="file" id="ocrInput" style="display:none" accept="image/*" onchange="runOCR(this.files[0])">

    <!-- TG Modal -->
    <div class="modal-overlay" id="tgModal">
        <div class="modal">
            <div class="flex j-between modal-title-row">
                <span class="bold c-pri" style="font-size:16px">Telegram Config</span>
                <span onclick="closeTG()" class="pointer" style="font-size:20px; padding:5px;">‚úï</span>
            </div>
            
            <div class="modal-input-col">
                <div class="modal-input-item">
                    <span class="modal-input-label" style="font-size:10px; color:var(--dim); display:block; margin-bottom:4px;">Bot Token</span>
                    <input type="text" id="tgToken" class="modal-input" placeholder="..." style="text-align:left; border-bottom:1px solid var(--dim);">
                </div>
                <div class="modal-input-item">
                    <span class="modal-input-label" style="font-size:10px; color:var(--dim); display:block; margin-bottom:4px;">Chat ID</span>
                    <input type="text" id="tgChatId" class="modal-input" placeholder="..." style="text-align:left; border-bottom:1px solid var(--dim);">
                </div>
            </div>

            <div class="toggle-switch" onclick="toggleProxy()">
                <div class="toggle-box active" id="proxyToggle"><div class="toggle-dot"></div></div>
                <span>CORS Proxy (Recommended)</span>
            </div>

            <button class="modal-btn full-w" onclick="testTG()">Test Send</button>
        </div>
    </div>

    <script>
        const sys = { token: 'ETH', price: 0, source: 'binance', ws: null, useProxy: true, lastStratTime: 0, theme: 'dark' };

        // --- Data Persistence ---
        function saveData() {
            const data = {
                lPrice: document.getElementById('lPrice').value,
                lSize: document.getElementById('lSize').value,
                sPrice: document.getElementById('sPrice').value,
                sSize: document.getElementById('sSize').value,
                wallet: document.getElementById('wallet').value,
                lev: document.getElementById('lev').value,
                token: sys.token,
                source: sys.source,
                theme: sys.theme,
                proxy: sys.useProxy,
                tgToken: document.getElementById('tgToken').value,
                tgChatId: document.getElementById('tgChatId').value
            };
            localStorage.setItem('cht_data_v23', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('cht_data_v23');
            if (!raw) {
                // First run defaults
                document.getElementById('wallet').value = 1500;
                document.getElementById('lev').value = 50;
                return;
            }
            try {
                const data = JSON.parse(raw);
                if(data.lPrice) document.getElementById('lPrice').value = data.lPrice;
                if(data.lSize) document.getElementById('lSize').value = data.lSize;
                if(data.sPrice) document.getElementById('sPrice').value = data.sPrice;
                if(data.sSize) document.getElementById('sSize').value = data.sSize;
                if(data.wallet) document.getElementById('wallet').value = data.wallet;
                if(data.lev) document.getElementById('lev').value = data.lev;
                
                if(data.token) { sys.token = data.token; document.getElementById('tokenSelect').value = data.token; document.getElementById('simUnit').innerText = data.token; }
                if(data.source) sys.source = data.source;
                if(data.theme) { sys.theme = data.theme; applyTheme(data.theme); }
                if(data.proxy !== undefined) { sys.useProxy = data.proxy; updateProxyUI(); }
                if(data.tgToken) document.getElementById('tgToken').value = data.tgToken;
                if(data.tgChatId) document.getElementById('tgChatId').value = data.tgChatId;
                
                updateSourceUI();
            } catch(e) { console.error("Load failed", e); }
        }

        window.onload = () => {
            loadData();
            initWS();
            calcAll();
        };

        // --- Core Logic ---
        function toggleTheme() {
            const themes = ['dark', 'light', 'pixel'];
            const next = themes[(themes.indexOf(sys.theme) + 1) % themes.length];
            sys.theme = next;
            applyTheme(next);
            saveData();
        }

        function applyTheme(t) {
            const b = document.body; const i = document.getElementById('themeIcon');
            b.classList.remove('light-mode', 'pixel-mode');
            if(t==='light') { b.classList.add('light-mode'); i.innerText='üåô'; }
            else if(t==='pixel') { b.classList.add('pixel-mode'); i.innerText='üëæ'; }
            else { i.innerText='‚òÄÔ∏è'; }
        }

        function setSource(src) {
            sys.source = src; updateSourceUI(); logAI(`Source: ${src.toUpperCase()}`); initWS(); saveData();
        }
        function updateSourceUI() {
            document.querySelectorAll('.source-tag').forEach(el => el.classList.remove('active'));
            document.getElementById(sys.source === 'binance' ? 'srcBinance' : 'srcOkx').classList.add('active');
        }
        function switchSource() { setSource(sys.source === 'binance' ? 'okx' : 'binance'); }

        function initWS() {
            if(sys.ws) sys.ws.close();
            const symbol = sys.token.toLowerCase();
            if(sys.source === 'binance') {
                sys.ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}usdt@trade`);
                sys.ws.onmessage = (e) => { sys.price = parseFloat(JSON.parse(e.data).p); updateUI(); };
            } else {
                sys.ws = new WebSocket('wss://ws.okx.com:8443/ws/v5/public');
                sys.ws.onopen = () => { sys.ws.send(JSON.stringify({ "op": "subscribe", "args": [{"channel": "tickers", "instId": `${sys.token.toUpperCase()}-USDT-SWAP`}] })); };
                sys.ws.onmessage = (e) => { const d = JSON.parse(e.data); if(d.data && d.data[0]) { sys.price = parseFloat(d.data[0].last); updateUI(); } };
            }
        }

        function updateUI() { document.getElementById('priceDisplay').innerText = sys.price.toFixed(2); calcAll(); }
        function get(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function set(id, val) { document.getElementById(id).value = val; }

        function calcAll() {
            // Save on every calc to ensure latest state is kept
            saveData();

            const p = sys.price; if(!p) return;
            const lP = get('lPrice'); const lS = get('lSize'); const sP = get('sPrice'); const sS = get('sSize');
            const w = get('wallet'); const lev = get('lev');

            document.getElementById('levDisplay').innerText = lev + "X";
            const lPnl = (p - lP) * lS; const sPnl = (sP - p) * sS; const net = lPnl + sPnl;
            const delta = lS - sS; const equity = w + net;

            const elNet = document.getElementById('netPnl'); elNet.innerText = (net>0?"+":"")+net.toFixed(2); elNet.className = net>=0 ? "bold c-safe" : "bold c-dan";
            document.getElementById('equity').innerText = equity.toFixed(2); document.getElementById('equity').className = equity < 500 ? "bold c-dan" : "bold c-safe";
            document.getElementById('lPnl').innerText = lPnl.toFixed(0); document.getElementById('sPnl').innerText = sPnl.toFixed(0);
            
            const dir = delta > 0 ? "LONG" : (delta < 0 ? "SHORT" : "FLAT");
            const elDelta = document.getElementById('netDelta'); elDelta.innerText = `${Math.abs(delta).toFixed(3)} ${dir}`;
            elDelta.className = delta > 0 ? "c-pri" : (delta < 0 ? "c-dan" : "c-dim");

            const mmr = 0.01; const num = (lP*lS) - (sP*sS) - w; const den = delta - (Math.max(lS, sS) * mmr);
            let liq = 0; if(Math.abs(den) > 0.0001) liq = num / den; if(liq < 0) liq = 0;

            const elBar = document.getElementById('riskBar');
            if(liq === 0) { document.getElementById('liqText').innerText = "LIQ: SAFE"; elBar.style.width = "5%"; elBar.style.background = "var(--safe)"; document.getElementById('riskText').innerText = "RISK: LOW"; } 
            else {
                document.getElementById('liqText').innerText = `LIQ: ${liq.toFixed(2)}`;
                const dist = Math.abs(p - liq) / p; let pct = Math.min(100, Math.max(5, dist > 0.2 ? 20 : (1 - dist/0.2)*100));
                elBar.style.width = pct + "%"; elBar.style.background = pct > 80 ? "var(--dan)" : (pct > 50 ? "var(--warn)" : "var(--safe)");
                document.getElementById('riskText').innerText = pct > 80 ? "CRITICAL" : (pct>50?"HIGH":"LOW");
            }
            calcSim(lP, lS, sP, sS, liq);
            if(Date.now() - sys.lastStratTime > 1500) { updateStrat(delta, p); sys.lastStratTime = Date.now(); }
        }

        function calcSim(lP, lS, sP, sS, currLiq) {
            if(!lP) { lP = get('lPrice'); lS = get('lSize'); sP = get('sPrice'); sS = get('sSize'); }
            const simP = get('simPrice'); const simA = get('simAmt');
            if(!simP || !simA) { document.getElementById('simNewAvg').innerText = "--"; document.getElementById('simNewLiq').innerText = "--"; return; }

            let newLP = lP, newLS = lS, newSP = sP, newSS = sS; let targetSide = "";
            if (simA > 0) { targetSide = "Long"; newLS = lS + simA; newLP = ((lP * lS) + (simP * simA)) / newLS; } 
            else { targetSide = "Short"; const absA = Math.abs(simA); newSS = sS + absA; newSP = ((sP * sS) + (simP * absA)) / newSS; }

            document.getElementById('simNewAvg').innerText = `${targetSide} ${targetSide==="Long"?newLP.toFixed(2):newSP.toFixed(2)}`;
            const w = get('wallet'); const mmr = 0.01; const delta = newLS - newSS; const num = (newLP*newLS) - (newSP*newSS) - w; const den = delta - (Math.max(newLS, newSS) * mmr);
            let newLiq = 0; if(Math.abs(den) > 0.0001) newLiq = num / den; if(newLiq < 0) newLiq = 0;
            document.getElementById('simNewLiq').innerText = newLiq > 0 ? newLiq.toFixed(2) : "SAFE";
        }

        function loadSim(price, type) { document.getElementById('simPrice').value = price; document.getElementById('simAmt').value = type === 'support' ? 0.2 : -0.2; logAI(`Sim: ${price}`); calcAll(); }

        function updateStrat(delta, p) {
            const res = [1.05, 1.025, 1.01]; const sup = [0.99, 0.975, 0.95];
            let html = `<table class="strat-table"><thead><tr><th>ÁÇπ‰Ωç</th><th>Á±ªÂûã</th><th>Ë∑ùÁ¶ª</th><th>Êìç‰Ωú</th></tr></thead><tbody>`;
            res.reverse().forEach(r => { const tp = p * r; const dist = ((tp - p)/p*100).toFixed(2); html += `<tr onclick="loadSim(${tp.toFixed(2)}, 'resist')"><td class="bold">${tp.toFixed(2)}</td><td class="c-dan">ÈòªÂäõ</td><td class="c-dim">${dist}%</td><td><span class="strat-btn">Load</span></td></tr>`; });
            html += `<tr><td colspan="4" class="text-center c-dim" style="padding:4px">--- ${p.toFixed(2)} ---</td></tr>`;
            sup.forEach(s => { const tp = p * s; const dist = ((p - tp)/p*100).toFixed(2); html += `<tr onclick="loadSim(${tp.toFixed(2)}, 'support')"><td class="bold">${tp.toFixed(2)}</td><td class="c-safe">ÊîØÊíë</td><td class="c-dim">-${dist}%</td><td><span class="strat-btn">Load</span></td></tr>`; });
            html += `</tbody></table>`; document.getElementById('stratContent').innerHTML = html;
        }

        // TG Modal Control
        function openTG() { document.getElementById('tgModal').classList.add('show'); }
        function closeTG() { document.getElementById('tgModal').classList.remove('show'); saveData(); }
        function toggleProxy() { 
            sys.useProxy = !sys.useProxy; 
            updateProxyUI();
            saveData();
        }
        function updateProxyUI() {
            const box = document.getElementById('proxyToggle');
            if(sys.useProxy) box.classList.add('active'); else box.classList.remove('active');
        }
        
        async function sendTG(msg) {
            const t = document.getElementById('tgToken').value.trim(); const c = document.getElementById('tgChatId').value.trim();
            if(!t || !c) { openTG(); return; }
            // Save immediately on send
            saveData();
            
            let url = `https://api.telegram.org/bot${t}/sendMessage?chat_id=${c}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
            if(sys.useProxy) url = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            
            try { 
                const r = await fetch(url); const d = await r.json(); 
                if(d.ok||d.result) { logAI("TG Sent", "c-safe"); closeTG(); } else throw new Error(); 
            } catch(e) { alert("Failed. Check Proxy/Network."); }
        }
        function testTG() { sendTG(`üëã <b>TEST</b>\n@oAdam`); }
        function sendReport() { const p = document.getElementById('priceDisplay').innerText; const net = document.getElementById('netPnl').innerText; const eq = document.getElementById('equity').innerText; const d = document.getElementById('netDelta').innerText; sendTG(`üìä <b>${sys.token}</b>\nPrice: ${p}\nPnL: ${net}\nEq: ${eq}\nDelta: ${d}`); }

        function changeToken() { sys.token = document.getElementById('tokenSelect').value; document.getElementById('simUnit').innerText = sys.token; logAI(`Token: ${sys.token}`); initWS(); saveData(); }
        function logAI(msg, cls='') { const b = document.getElementById('aiLog'); const d = document.createElement('div'); d.className = `ai-log-item new ${cls}`; d.innerText = `> ${msg}`; b.appendChild(d); if(b.children.length>2) b.firstElementChild.remove(); }

        async function runOCR(file) {
            if(!file) return; logAI("Scanning...");
            try {
                const w = await Tesseract.createWorker('chi_sim'); const r = await w.recognize(file); await w.terminate();
                const t = r.data.text.replace(/,/g,'').replace(/\s+/g,' ');
                const sM = [...t.matchAll(/(?:Êï∞Èáè|Size)[^\d]*(\d+\.?\d*)/gi)]; const pM = [...t.matchAll(/(?:‰ª∑Ê†º|Price|Entry)[^\d]*(\d+\.?\d*)/gi)];
                if(sM.length && pM.length) { 
                    set('lSize', sM[0][1]); set('lPrice', pM[0][1]); if(sM[1]) set('sSize', sM[1][1]); if(pM[1]) set('sPrice', pM[1][1]); 
                    calcAll(); // Will trigger save
                    logAI("OCR Success"); 
                } else logAI("OCR Failed", "c-dan");
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>

